transform {

	param "filename" { select "'addressbook.sda'" }
	variable "doc" { select "sdt:document-node(document($filename))" }

	foreach "$doc/addressbook/contact/phonenumber" {
		println "concat('Number ', $sdt:position, ' of ', $sdt:last, ': ', ., ' (', ../firstname, ')')"
	}

	node "contacts" {
		foreach "$doc/addressbook/contact" {
			group "count(phonenumber)"		
			sort "count(phonenumber)" { comparator "sdt:compare-number(?,?)" }
			sort "firstname" { reverse "true()" }
			node "group" {
				node "phones" { 
					value "$sdt:current-grouping-key" 
				}
				foreach "$sdt:current-group" {
					node "person" { 
						value "concat(upper-case(firstname),.)"
						copy "firstname"
						node "phonenumbers" {
							value "fn:string-join(phonenumber,',')"
						}
					}
				}		
			}
		}	
	}
	
	variable "V" { select "0" }
	foreach "sdt:tokenize('a b c')" {
		variable "V" { select "$V + 1" }
		println "concat('V = ', $V)"
	}
	println "concat('Last V = ', $V)"
	if "true()" {
		variable "V" { select "fn:current-dateTime()" }
	}
	println "concat('Final V = ', $V)"
	
	foreach "sdt:tokenize('a b c')" {
		variable "position" { select "$sdt:position" }
		foreach "sdt:tokenize('d e')" {
			println "concat('outer ', $position, ' inner ', $sdt:position)"
		}
	}

}