transform {

	param "filename" { select "'addressbook.sda'" }
	variable "doc" { select "document($filename)" }
	
	foreach "$doc/addressbook/contact" {
		group "count(phonenumber)"
		println "concat('Contacts with ', $sdt:current-grouping-key, ' phone(s):')" 
		foreach "$sdt:current-group" {
			println "firstname"
		}
	}
	
	node "contacts" {
		foreach "$doc/addressbook/contact" {
			sort "count(phonenumber)" { comparator "sdt:compare-number(?,?)" }
			sort "firstname" { reverse "true()" }
			node "person" { 
				value "concat(upper-case(firstname),.)"
				copy "firstname"
				node "phones" {
					value "fn:string-join(phonenumber,',')"
				}
			}
		}	
	}
}